<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baustellenfotos Theilerhaus</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: #16213e;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            border-bottom: 1px solid #0f3460;
        }

        .header h1 {
            font-size: 1.1rem;
            color: #fff;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .github-link {
            color: #aaa;
            display: flex;
            align-items: center;
            padding: 6px;
            border-radius: 4px;
            transition: color 0.2s, background 0.2s;
        }

        .github-link:hover {
            color: #fff;
            background: rgba(255,255,255,0.1);
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-left: auto;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button {
            background: #e94560;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover {
            background: #ff6b6b;
        }

        button.secondary {
            background: #0f3460;
        }

        button.secondary:hover {
            background: #1a4a7a;
        }

        button.active {
            background: #4ecca3;
        }

        select, input[type="range"] {
            background: #0f3460;
            color: white;
            border: 1px solid #e94560;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        input[type="range"] {
            width: 100px;
        }

        label {
            font-size: 13px;
            color: #aaa;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }

        .viewer {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: #0f0f23;
            overflow: hidden;
        }

        .viewer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: opacity 0.3s;
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(233, 69, 96, 0.8);
            color: white;
            border: none;
            width: 50px;
            height: 80px;
            font-size: 24px;
            cursor: pointer;
            z-index: 10;
        }

        .nav-btn:hover {
            background: #e94560;
        }

        .nav-btn.prev { left: 0; border-radius: 0 5px 5px 0; }
        .nav-btn.next { right: 0; border-radius: 5px 0 0 5px; }

        .thumbnails {
            background: #16213e;
            padding: 10px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            max-height: 120px;
            border-bottom: 1px solid #0f3460;
        }

        .thumbnails::-webkit-scrollbar {
            height: 8px;
        }

        .thumbnails::-webkit-scrollbar-track {
            background: #0f3460;
        }

        .thumbnails::-webkit-scrollbar-thumb {
            background: #e94560;
            border-radius: 4px;
        }

        .thumb {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .thumb:hover {
            opacity: 0.9;
        }

        .thumb.active {
            opacity: 1;
            border-color: #e94560;
        }

        /* Two-column layout */
        .app-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .folder-nav {
            width: 264px;
            min-width: 140px;
            max-width: 450px;
            background: #141e30;
            padding: 12px 8px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .resize-handle {
            width: 4px;
            background: #0a1628;
            cursor: col-resize;
            flex-shrink: 0;
            transition: background 0.15s;
            position: relative;
        }

        .resize-handle:hover,
        .resize-handle.dragging {
            background: #e94560;
        }

        .resize-handle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 32px;
            background: #2a3f5f;
            border-radius: 1px;
        }

        .resize-handle:hover::after,
        .resize-handle.dragging::after {
            background: rgba(255,255,255,0.5);
        }

        .folder-nav-title {
            color: #aaa;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 5px 10px;
            margin-bottom: 5px;
        }

        .select-folder-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            padding: 14px 24px;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: rgba(15, 52, 96, 0.9);
            border: 2px solid #e94560;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .select-folder-btn:hover {
            background: rgba(233, 69, 96, 0.9);
        }

        .select-folder-btn .icon {
            font-size: 22px;
        }

        /* After images loaded, move to top-right */
        body.has-images .select-folder-btn {
            top: 15px;
            left: auto;
            right: 15px;
            transform: none;
        }

        body.fullscreen .select-folder-btn {
            display: none;
        }

        .format-hint {
            position: absolute;
            top: calc(50% + 50px);
            left: 50%;
            transform: translateX(-50%);
            color: #666;
            font-size: 12px;
            text-align: center;
        }

        body.has-images .format-hint {
            display: none;
        }

        /* Hide controls when no images loaded */
        body:not(.has-images) .player-controls,
        body:not(.has-images) .nav-btn,
        body:not(.has-images) .thumbnails {
            display: none;
        }

        .browser-warning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #aaa;
            padding: 20px;
            max-width: 400px;
        }

        .browser-warning .warning-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.6;
        }

        .browser-warning h3 {
            color: #e94560;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .browser-warning p {
            font-size: 14px;
            line-height: 1.5;
        }

        body.has-images .browser-warning {
            display: none;
        }

        .folder-btn {
            padding: 8px 12px;
            font-size: 12px;
            text-align: left;
            border-radius: 4px;
            background: transparent;
            color: #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .folder-btn:hover {
            background: #0f3460;
            color: white;
        }

        .folder-btn.active {
            background: #e94560;
            color: white;
        }

        .folder-btn .folder-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
        }

        .folder-btn .folder-count {
            flex-shrink: 0;
            opacity: 0.6;
            font-size: 11px;
        }

        .folder-btn .folder-toggle {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            transition: transform 0.2s;
            font-size: 10px;
            opacity: 0.7;
        }

        .folder-btn .folder-toggle:hover {
            opacity: 1;
        }

        .folder-btn.expanded .folder-toggle {
            transform: rotate(90deg);
        }

        .folder-files {
            display: none;
            padding-left: 12px;
        }

        .folder-files.visible {
            display: block;
        }

        .file-btn {
            padding: 4px 8px 4px 16px;
            font-size: 11px;
            text-align: left;
            border-radius: 3px;
            background: transparent;
            color: #999;
            display: block;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-btn:hover {
            background: #0f3460;
            color: #ddd;
        }

        .file-btn.active {
            background: #4a2040;
            color: #e94560;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* YouTube-style player controls */
        .player-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            padding: 40px 15px 10px 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
            transition: opacity 0.3s;
        }

        .player-controls .progress-bar {
            height: 5px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .player-controls .progress-bar:hover {
            height: 7px;
        }

        .player-controls .progress {
            height: 100%;
            background: #e94560;
            border-radius: 2px;
            transition: width 0.1s linear;
        }

        .controls-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .controls-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .controls-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .player-btn {
            background: transparent;
            color: white;
            border: none;
            padding: 8px;
            cursor: pointer;
            font-size: 18px;
            opacity: 0.9;
            transition: opacity 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
        }

        .player-btn:hover {
            opacity: 1;
            background: transparent;
            transform: scale(1.1);
        }

        .player-btn.play-btn {
            font-size: 22px;
        }

        .player-controls .counter {
            color: white;
            font-size: 13px;
            opacity: 0.9;
            white-space: nowrap;
        }

        .player-controls .file-info {
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Fullscreen styles */
        body.fullscreen .header,
        body.fullscreen .folder-nav,
        body.fullscreen .thumbnails,
        body.fullscreen .resize-handle {
            display: none;
        }

        body.fullscreen .app-container {
            height: 100vh;
        }

        body.fullscreen .main-container {
            height: 100vh;
        }

        body.fullscreen .player-controls,
        body.fullscreen .nav-btn {
            opacity: 1;
            transition: opacity 0.3s;
        }

        body.fullscreen.controls-hidden .player-controls,
        body.fullscreen.controls-hidden .nav-btn {
            opacity: 0;
            pointer-events: none;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 3px solid rgba(233, 69, 96, 0.2);
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .loading.visible {
            opacity: 1;
        }

        /* App loading overlay */
        .app-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1a1a2e;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.3s;
        }

        .app-loader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .app-loader .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(233, 69, 96, 0.2);
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin-simple 0.8s linear infinite;
        }

        .app-loader .loader-text {
            color: #aaa;
            font-size: 14px;
        }

        /* Folder filter overlay */
        .filter-loader {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 15, 35, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .filter-loader.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .filter-loader .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid rgba(233, 69, 96, 0.2);
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin-simple 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        @keyframes spin-simple {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header {
                padding: 10px;
            }
            .header h1 {
                font-size: 1rem;
                width: 100%;
            }
            .controls {
                width: 100%;
                justify-content: center;
            }
            .nav-btn {
                width: 40px;
                height: 60px;
                font-size: 18px;
            }
            .thumb {
                width: 60px;
                height: 60px;
            }
            .player-controls .file-info {
                display: none;
            }
            .player-btn {
                min-width: 32px;
                height: 32px;
                font-size: 16px;
            }
            .player-btn.play-btn {
                font-size: 20px;
            }
            .folder-nav,
            .resize-handle {
                display: none;
            }
            .app-container {
                height: calc(100vh - 100px);
            }
        }
    </style>
</head>
<body>
    <!-- App loading overlay -->
    <div class="app-loader" id="appLoader">
        <div class="spinner"></div>
        <div class="loader-text">Lade Galerie...</div>
    </div>

    <div class="header">
        <h1>Baustellenfotos Theilerhaus</h1>
        <div class="controls">
            <div class="control-group">
                <label>Dauer:</label>
                <input type="range" id="duration" min="1" max="10" value="3" onchange="updateDuration()">
                <span id="durationLabel">3s</span>
            </div>
            <div class="control-group">
                <label>Sortieren:</label>
                <select id="sortOrder" onchange="sortImages()">
                    <option value="folder-asc">Ordner A-Z</option>
                    <option value="folder-desc">Ordner Z-A</option>
                    <option value="name-asc">Dateiname A-Z</option>
                    <option value="name-desc">Dateiname Z-A</option>
                </select>
            </div>
        </div>
        <a href="https://github.com/davras5/Glimpse" target="_blank" class="github-link" title="Quellcode auf GitHub">
            <svg height="20" width="20" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
            </svg>
        </a>
    </div>

    <div class="app-container">
        <div class="folder-nav" id="folderNav">
            <div class="folder-nav-title">Ordner</div>
        </div>
        <div class="resize-handle" id="resizeHandle"></div>

        <div class="main-container">
        <div class="thumbnails" id="thumbnails"></div>

        <div class="viewer" onclick="navigate(1)">
            <button class="select-folder-btn" id="selectFolderBtn" onclick="event.stopPropagation(); selectFolder()" title="Bilderordner öffnen">
                <span class="icon">&#128193;</span>
                <span>Ordner wählen...</span>
            </button>
            <div class="format-hint">Unterstützte Formate: JPG, PNG, GIF, WebP, BMP</div>
            <!-- Hidden file input for browsers without File System Access API -->
            <input type="file" id="folderInput" webkitdirectory multiple accept="image/*" style="display: none;" onchange="handleFolderInput(this)">
            <!-- Warning for unsupported browsers -->
            <div class="browser-warning" id="browserWarning" style="display: none;">
                <div class="warning-icon">&#9888;</div>
                <h3>Browser nicht unterstützt</h3>
                <p>Ihr Browser unterstützt die Ordnerauswahl leider nicht. Bitte verwenden Sie Chrome, Edge, Firefox oder einen anderen modernen Browser.</p>
            </div>
            <button class="nav-btn prev" onclick="event.stopPropagation(); navigate(-1)" title="Vorheriges Bild (←)">&#10094;</button>
            <img id="mainImage" src="" alt="Baustellenfoto">
            <button class="nav-btn next" onclick="event.stopPropagation(); navigate(1)" title="Nächstes Bild (→)">&#10095;</button>
            <div class="loading" id="loading"></div>
            <div class="filter-loader" id="filterLoader"><div class="spinner"></div></div>

            <!-- YouTube-style player controls -->
            <div class="player-controls" onclick="event.stopPropagation()">
                <div class="progress-bar" onclick="seekProgress(event)">
                    <div class="progress" id="progress"></div>
                </div>
                <div class="controls-row">
                    <div class="controls-left">
                        <button class="player-btn play-btn" id="playBtnPlayer" onclick="togglePlay()" title="Abspielen/Pause (Leertaste)">&#9654;</button>
                        <button class="player-btn" onclick="navigate(-1)" title="Vorheriges Bild (←)">&#10094;</button>
                        <button class="player-btn" onclick="navigate(1)" title="Nächstes Bild (→)">&#10095;</button>
                        <span class="file-info"><span id="currentFolder2"></span><span id="currentFile2"></span></span>
                    </div>
                    <div class="controls-right">
                        <span class="counter" id="counter"></span>
                        <button class="player-btn" onclick="toggleFullscreen()" title="Vollbild (F)">&#x26F6;</button>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <script>
        // Image list - starts empty, populated when user selects a folder
        let allImages = [];

        // File System Access API state
        let directoryHandle = null;
        let fileHandlesMap = new Map(); // path -> FileSystemFileHandle
        const IMAGE_EXTENSIONS = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'];

        let images = [...allImages];
        let currentIndex = 0;
        let isPlaying = false;
        let playInterval = null;
        let duration = 3000;
        let currentFolder = 'all';
        let hideControlsTimeout = null;
        let loadingTimeout = null;
        const preloadCache = new Map(); // Cache for preloaded images
        const PRELOAD_COUNT = 2; // Number of images to preload ahead

        // Get unique folders
        let folders = [...new Set(allImages.map(img => img.split('/')[0]))].sort();

        // Check browser support for folder selection
        function checkBrowserSupport() {
            const hasFileSystemAccess = 'showDirectoryPicker' in window;
            const hasWebkitDirectory = 'webkitdirectory' in document.createElement('input');
            return hasFileSystemAccess || hasWebkitDirectory;
        }

        // Initialize
        async function init() {
            updateDuration();

            // Check browser support and show warning if needed
            if (!checkBrowserSupport()) {
                document.getElementById('selectFolderBtn').style.display = 'none';
                document.getElementById('browserWarning').style.display = 'block';
                document.querySelector('.format-hint').style.display = 'none';
            }

            // Hide app loader immediately (no images to load initially)
            document.getElementById('appLoader').classList.add('hidden');

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') navigate(-1);
                if (e.key === 'ArrowRight') navigate(1);
                if (e.key === ' ') { e.preventDefault(); togglePlay(); }
                if (e.key === 'f' || e.key === 'F') toggleFullscreen();
                if (e.key === 'Escape' && document.body.classList.contains('fullscreen')) toggleFullscreen();
                // Show controls on any key press in fullscreen
                if (document.body.classList.contains('fullscreen')) {
                    showFullscreenControls();
                }
            });

            // Mouse move to show controls in fullscreen
            document.addEventListener('mousemove', () => {
                if (document.body.classList.contains('fullscreen')) {
                    showFullscreenControls();
                }
            });
        }

        function showFullscreenControls() {
            document.body.classList.remove('controls-hidden');
            clearTimeout(hideControlsTimeout);
            hideControlsTimeout = setTimeout(() => {
                if (document.body.classList.contains('fullscreen')) {
                    document.body.classList.add('controls-hidden');
                }
            }, 3000);
        }

        function buildFolderNav() {
            const nav = document.getElementById('folderNav');
            nav.innerHTML = '<div class="folder-nav-title">Ordner</div>';
            nav.innerHTML += `<button class="folder-btn active" onclick="filterByFolder('all')"><span class="folder-name">Alle Fotos</span><span class="folder-count">${allImages.length}</span></button>`;

            folders.forEach(folder => {
                const folderImages = allImages.filter(img => img.startsWith(folder + '/'));
                const count = folderImages.length;
                const escapedFolder = folder.replace(/'/g, "\\'");

                // Folder button with toggle
                let html = `<button class="folder-btn" data-folder="${escapedFolder}" onclick="toggleFolder(this, '${escapedFolder}', event)">
                    <span class="folder-toggle">&#9658;</span>
                    <span class="folder-name">${folder}</span>
                    <span class="folder-count">${count}</span>
                </button>`;

                // Files container
                html += `<div class="folder-files" data-folder="${escapedFolder}">`;
                folderImages.forEach(imgPath => {
                    const fileName = imgPath.split('/').pop();
                    const escapedPath = imgPath.replace(/'/g, "\\'");
                    html += `<button class="file-btn" data-path="${escapedPath}" onclick="showSingleFile(event, '${escapedPath}')" title="${fileName}">${fileName}</button>`;
                });
                html += '</div>';

                nav.innerHTML += html;
            });
        }

        function toggleFolder(btn, folder, e) {
            // Check if click was on the toggle arrow
            const isToggleClick = e && e.target.classList.contains('folder-toggle');
            const filesContainer = document.querySelector(`.folder-files[data-folder="${folder}"]`);
            const isExpanded = btn.classList.contains('expanded');

            if (isToggleClick) {
                // Just toggle expand/collapse
                e.stopPropagation();
                if (isExpanded) {
                    btn.classList.remove('expanded');
                    filesContainer.classList.remove('visible');
                } else {
                    btn.classList.add('expanded');
                    filesContainer.classList.add('visible');
                }
            } else {
                // Filter by folder and expand
                if (!isExpanded) {
                    btn.classList.add('expanded');
                    filesContainer.classList.add('visible');
                }
                filterByFolder(folder);
            }
        }

        function showSingleFile(e, imgPath) {
            e.stopPropagation();

            // Update active states
            document.querySelectorAll('.folder-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.file-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.file-btn[data-path="${imgPath.replace(/'/g, "\\'")}"]`)?.classList.add('active');

            // Set to single image mode
            images = [imgPath];
            currentIndex = 0;
            currentFolder = 'single';
            preloadCache.clear();
            buildThumbnails();
            showImage(0);
        }

        function filterByFolder(folder) {
            // Show filter loader
            const filterLoader = document.getElementById('filterLoader');
            filterLoader.classList.add('visible');

            // Update active state immediately for responsiveness
            document.querySelectorAll('.folder-btn').forEach((btn) => {
                const nameSpan = btn.querySelector('.folder-name');
                const btnFolder = nameSpan ? nameSpan.textContent : '';
                btn.classList.toggle('active',
                    (folder === 'all' && btnFolder === 'Alle Fotos') || btnFolder === folder);
            });

            // Clear file button active states
            document.querySelectorAll('.file-btn').forEach(b => b.classList.remove('active'));

            // Defer heavy work to allow UI to update
            setTimeout(async () => {
                currentFolder = folder;
                if (folder === 'all') {
                    images = [...allImages];
                } else {
                    images = allImages.filter(img => img.startsWith(folder + '/'));
                }
                preloadCache.clear();
                sortImages();
                currentIndex = 0;
                buildThumbnails();
                showImage(0);

                // Hide filter loader after image loads and renders
                const mainImg = document.getElementById('mainImage');
                const hideLoader = () => {
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            setTimeout(() => {
                                filterLoader.classList.remove('visible');
                            }, 30);
                        });
                    });
                };
                if (mainImg.complete && mainImg.naturalWidth > 0) {
                    hideLoader();
                } else {
                    mainImg.addEventListener('load', hideLoader, { once: true });
                    setTimeout(hideLoader, 1000);
                }
            }, 50);
        }

        async function sortImages() {
            const order = document.getElementById('sortOrder').value;
            preloadCache.clear(); // Clear cache when order changes
            images.sort((a, b) => {
                const folderA = a.split('/')[0];
                const folderB = b.split('/')[0];
                const nameA = a.split('/').pop();
                const nameB = b.split('/').pop();

                switch(order) {
                    case 'folder-asc':
                        return folderA.localeCompare(folderB) || nameA.localeCompare(nameB);
                    case 'folder-desc':
                        return folderB.localeCompare(folderA) || nameA.localeCompare(nameB);
                    case 'name-asc':
                        return nameA.localeCompare(nameB);
                    case 'name-desc':
                        return nameB.localeCompare(nameA);
                }
            });
            buildThumbnails();
            showImage(currentIndex);
        }

        // Track thumbnail blob URLs for cleanup
        const thumbnailBlobUrls = new Set();

        function buildThumbnails() {
            const container = document.getElementById('thumbnails');

            // Revoke old thumbnail blob URLs to prevent memory leak
            for (const url of thumbnailBlobUrls) {
                URL.revokeObjectURL(url);
            }
            thumbnailBlobUrls.clear();

            container.innerHTML = '';

            for (let i = 0; i < images.length; i++) {
                const imgPath = images[i];
                const thumb = document.createElement('img');
                thumb.className = 'thumb' + (i === currentIndex ? ' active' : '');
                thumb.onclick = ((idx) => () => showImage(idx))(i);
                thumb.loading = 'lazy';

                // Check if using File System Access API or fallback
                const fileHandle = fileHandlesMap.get(imgPath);
                const fileObject = fileObjectsMap.get(imgPath);

                if (fileHandle) {
                    // Load thumbnail via blob URL (File System Access API)
                    (async (thumbEl, handle, blobUrls) => {
                        try {
                            const file = await handle.getFile();
                            const url = URL.createObjectURL(file);
                            blobUrls.add(url);
                            thumbEl.src = url;
                        } catch (err) {
                            thumbEl.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>';
                        }
                    })(thumb, fileHandle, thumbnailBlobUrls);
                } else if (fileObject) {
                    // Load thumbnail via blob URL (fallback File object)
                    const url = URL.createObjectURL(fileObject);
                    thumbnailBlobUrls.add(url);
                    thumb.src = url;
                } else {
                    thumb.src = encodeURI(imgPath);
                }

                container.appendChild(thumb);
            }
        }

        function preloadAhead() {
            // Preload next N images
            for (let i = 1; i <= PRELOAD_COUNT; i++) {
                const nextIndex = (currentIndex + i) % images.length;
                const nextPath = images[nextIndex];

                // Skip if already cached
                if (preloadCache.has(nextPath)) continue;

                const preloadImg = new Image();
                preloadImg.src = encodeURI(nextPath);
                preloadCache.set(nextPath, preloadImg);
            }

            // Clean up old cache entries (keep only nearby images)
            if (preloadCache.size > PRELOAD_COUNT + 3) {
                const keepPaths = new Set();
                for (let i = -1; i <= PRELOAD_COUNT; i++) {
                    const idx = (currentIndex + i + images.length) % images.length;
                    keepPaths.add(images[idx]);
                }
                for (const path of preloadCache.keys()) {
                    if (!keepPaths.has(path)) {
                        preloadCache.delete(path);
                    }
                }
            }
        }

        function navigate(dir) {
            showImage(currentIndex + dir);
            if (isPlaying) resetPlayInterval();
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            // Update player button icon (▶ = play, ⏸ = pause)
            const playBtn = document.getElementById('playBtnPlayer');
            playBtn.innerHTML = isPlaying ? '&#9208;' : '&#9654;';

            if (isPlaying) {
                playInterval = setInterval(() => navigate(1), duration);
            } else {
                clearInterval(playInterval);
            }
        }

        function resetPlayInterval() {
            if (isPlaying) {
                clearInterval(playInterval);
                playInterval = setInterval(() => navigate(1), duration);
            }
        }

        function updateDuration() {
            const slider = document.getElementById('duration');
            duration = slider.value * 1000;
            document.getElementById('durationLabel').textContent = slider.value + 's';
            resetPlayInterval();
        }

        function seekProgress(e) {
            const rect = e.target.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            showImage(Math.floor(percent * images.length));
        }

        function toggleFullscreen() {
            document.body.classList.toggle('fullscreen');
            if (document.body.classList.contains('fullscreen')) {
                document.documentElement.requestFullscreen?.() ||
                document.documentElement.webkitRequestFullscreen?.();
                // Start auto-hide timer
                showFullscreenControls();
            } else {
                document.exitFullscreen?.() || document.webkitExitFullscreen?.();
                // Clear timer and show controls
                clearTimeout(hideControlsTimeout);
                document.body.classList.remove('controls-hidden');
            }
        }

        // Resize handle functionality
        function initResize() {
            const handle = document.getElementById('resizeHandle');
            const nav = document.getElementById('folderNav');
            let isResizing = false;

            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                handle.classList.add('dragging');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                const newWidth = e.clientX;
                if (newWidth >= 120 && newWidth <= 400) {
                    nav.style.width = newWidth + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    handle.classList.remove('dragging');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // File System Access API - Select and scan folder
        async function selectFolder() {
            // Check API support - use fallback if not available
            if (!('showDirectoryPicker' in window)) {
                // Use fallback file input
                document.getElementById('folderInput').click();
                return;
            }

            try {
                // Show app loader during scanning
                const appLoader = document.getElementById('appLoader');
                const loaderText = appLoader.querySelector('.loader-text');
                appLoader.classList.remove('hidden');
                loaderText.textContent = 'Scanne Ordner...';

                // Request directory access
                directoryHandle = await window.showDirectoryPicker();
                fileHandlesMap.clear();

                // Scan recursively for images
                const scannedImages = [];
                await scanDirectory(directoryHandle, '', scannedImages);

                loadImagesIntoGallery(scannedImages);

            } catch (err) {
                // User cancelled or error
                const appLoader = document.getElementById('appLoader');
                if (err.name !== 'AbortError') {
                    console.error('Folder selection error:', err);
                }
                appLoader.classList.add('hidden');
            }
        }

        // Helper: Load scanned images into gallery UI
        function loadImagesIntoGallery(scannedImages) {
            const appLoader = document.getElementById('appLoader');
            const loaderText = appLoader.querySelector('.loader-text');

            if (scannedImages.length === 0) {
                loaderText.textContent = 'Keine Bilder gefunden';
                setTimeout(() => appLoader.classList.add('hidden'), 1500);
                return false;
            }

            // Update image list
            allImages = scannedImages.sort();
            images = [...allImages];
            preloadCache.clear();

            // Rebuild folders list
            const newFolders = [...new Set(allImages.map(img => img.split('/')[0]))].sort();
            folders.length = 0;
            folders.push(...newFolders);

            // Reset and rebuild UI
            currentFolder = 'all';
            currentIndex = 0;
            buildFolderNav();
            buildThumbnails();

            // Add has-images class to move button to top-right
            document.body.classList.add('has-images');

            // Update button text to indicate folder can be changed
            const btnText = document.querySelector('#selectFolderBtn span:last-child');
            if (btnText) btnText.textContent = 'Ordner ändern...';

            loaderText.textContent = `${scannedImages.length} Bilder gefunden`;

            // Show first image then hide loader
            showImage(0);
            const mainImg = document.getElementById('mainImage');
            const hideLoader = () => {
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            appLoader.classList.add('hidden');
                            loaderText.textContent = 'Lade Galerie...';
                        }, 300);
                    });
                });
            };
            if (mainImg.complete && mainImg.naturalWidth > 0) {
                hideLoader();
            } else {
                mainImg.addEventListener('load', hideLoader, { once: true });
                setTimeout(hideLoader, 2000);
            }
            return true;
        }

        async function scanDirectory(dirHandle, path, results) {
            for await (const entry of dirHandle.values()) {
                const entryPath = path ? `${path}/${entry.name}` : entry.name;

                if (entry.kind === 'directory') {
                    // Skip hidden directories
                    if (!entry.name.startsWith('.')) {
                        await scanDirectory(entry, entryPath, results);
                    }
                } else if (entry.kind === 'file') {
                    // Check if it's an image
                    const ext = entry.name.toLowerCase().substring(entry.name.lastIndexOf('.'));
                    if (IMAGE_EXTENSIONS.includes(ext)) {
                        results.push(entryPath);
                        fileHandlesMap.set(entryPath, entry);
                    }
                }
            }
        }

        // Fallback: Handle folder input for browsers without File System Access API
        const fileObjectsMap = new Map(); // path -> File object (for fallback)

        async function handleFolderInput(input) {
            const files = input.files;
            if (!files || files.length === 0) return;

            // Show app loader during processing
            const appLoader = document.getElementById('appLoader');
            const loaderText = appLoader.querySelector('.loader-text');
            appLoader.classList.remove('hidden');
            loaderText.textContent = 'Verarbeite Dateien...';

            // Clear previous state
            fileHandlesMap.clear();
            fileObjectsMap.clear();
            preloadCache.clear();

            const scannedImages = [];

            // Process files - webkitRelativePath contains folder structure
            for (const file of files) {
                const ext = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
                if (IMAGE_EXTENSIONS.includes(ext)) {
                    // webkitRelativePath is like "RootFolder/SubFolder/image.jpg"
                    // We want to strip the root folder to match our structure
                    let relativePath = file.webkitRelativePath;

                    // Remove the root folder from path (first segment)
                    const pathParts = relativePath.split('/');
                    if (pathParts.length > 1) {
                        // Keep subfolder/filename structure
                        relativePath = pathParts.slice(1).join('/');
                    }

                    // Only add if it has a folder structure (skip root-level files)
                    if (relativePath.includes('/')) {
                        scannedImages.push(relativePath);
                        fileObjectsMap.set(relativePath, file);
                    } else {
                        // Root level file - use full path
                        scannedImages.push(file.webkitRelativePath);
                        fileObjectsMap.set(file.webkitRelativePath, file);
                    }
                }
            }

            // Reset input for future selections
            input.value = '';

            loadImagesIntoGallery(scannedImages);
        }

        // Display image - handles File System Access API, fallback, and path-based loading
        async function showImage(index) {
            if (images.length === 0) return;

            currentIndex = (index + images.length) % images.length;
            const img = document.getElementById('mainImage');
            const loading = document.getElementById('loading');
            const imagePath = images[currentIndex];

            // Clear any pending loading indicator
            clearTimeout(loadingTimeout);
            loading.classList.remove('visible');

            // Check if we have a file handle (File System Access API) or file object (fallback)
            const fileHandle = fileHandlesMap.get(imagePath);
            const fileObject = fileObjectsMap.get(imagePath);

            if (fileHandle) {
                // Use File System Access API
                loadingTimeout = setTimeout(() => {
                    loading.classList.add('visible');
                }, 300);

                try {
                    const file = await fileHandle.getFile();
                    const url = URL.createObjectURL(file);

                    // Revoke old blob URL if exists
                    if (img.src.startsWith('blob:')) {
                        URL.revokeObjectURL(img.src);
                    }

                    const newImg = new Image();
                    newImg.onload = () => {
                        clearTimeout(loadingTimeout);
                        loading.classList.remove('visible');
                        img.src = url;
                        preloadAheadFS();
                    };
                    newImg.onerror = () => {
                        clearTimeout(loadingTimeout);
                        loading.classList.remove('visible');
                        URL.revokeObjectURL(url);
                    };
                    newImg.src = url;
                } catch (err) {
                    clearTimeout(loadingTimeout);
                    loading.classList.remove('visible');
                    console.error('Error loading image:', err);
                }
            } else if (fileObject) {
                // Use fallback File object (from input element)
                loadingTimeout = setTimeout(() => {
                    loading.classList.add('visible');
                }, 300);

                const url = URL.createObjectURL(fileObject);

                // Revoke old blob URL if exists
                if (img.src.startsWith('blob:')) {
                    URL.revokeObjectURL(img.src);
                }

                const newImg = new Image();
                newImg.onload = () => {
                    clearTimeout(loadingTimeout);
                    loading.classList.remove('visible');
                    img.src = url;
                    preloadAheadFallback();
                };
                newImg.onerror = () => {
                    clearTimeout(loadingTimeout);
                    loading.classList.remove('visible');
                    URL.revokeObjectURL(url);
                };
                newImg.src = url;
            } else {
                // Use original path-based loading (hardcoded list)
                const imageUrl = encodeURI(imagePath);
                const cached = preloadCache.get(imagePath);

                if (cached && cached.complete && cached.naturalWidth > 0) {
                    img.src = cached.src;
                    preloadAhead();
                } else {
                    loadingTimeout = setTimeout(() => {
                        loading.classList.add('visible');
                    }, 300);

                    const newImg = new Image();
                    newImg.onload = () => {
                        clearTimeout(loadingTimeout);
                        loading.classList.remove('visible');
                        img.src = newImg.src;
                        preloadCache.set(imagePath, newImg);
                        preloadAhead();
                    };
                    newImg.onerror = () => {
                        clearTimeout(loadingTimeout);
                        loading.classList.remove('visible');
                    };
                    newImg.src = imageUrl;
                }
            }

            // Update info in player controls
            const parts = images[currentIndex].split('/');
            document.getElementById('currentFolder2').textContent = parts[0] + ' / ';
            document.getElementById('currentFile2').textContent = parts[parts.length - 1];
            document.getElementById('counter').textContent = `${currentIndex + 1} / ${images.length}`;
            document.getElementById('progress').style.width = ((currentIndex + 1) / images.length * 100) + '%';

            // Update thumbnails
            document.querySelectorAll('.thumb').forEach((t, i) => {
                t.classList.toggle('active', i === currentIndex);
                if (i === currentIndex) {
                    t.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            });
        }

        // Preload for File System Access API
        async function preloadAheadFS() {
            for (let i = 1; i <= PRELOAD_COUNT; i++) {
                const nextIndex = (currentIndex + i) % images.length;
                const nextPath = images[nextIndex];
                const fileHandle = fileHandlesMap.get(nextPath);

                if (fileHandle && !preloadCache.has(nextPath)) {
                    try {
                        const file = await fileHandle.getFile();
                        const url = URL.createObjectURL(file);
                        const preloadImg = new Image();
                        preloadImg.src = url;
                        preloadImg._blobUrl = url; // Store for cleanup
                        preloadCache.set(nextPath, preloadImg);
                    } catch (err) {
                        // Ignore preload errors
                    }
                }
            }

            // Clean up old cache entries
            if (preloadCache.size > PRELOAD_COUNT + 3) {
                const keepPaths = new Set();
                for (let i = -1; i <= PRELOAD_COUNT; i++) {
                    const idx = (currentIndex + i + images.length) % images.length;
                    keepPaths.add(images[idx]);
                }
                for (const [path, img] of preloadCache.entries()) {
                    if (!keepPaths.has(path)) {
                        if (img._blobUrl) {
                            URL.revokeObjectURL(img._blobUrl);
                        }
                        preloadCache.delete(path);
                    }
                }
            }
        }

        // Preload for fallback File objects
        function preloadAheadFallback() {
            for (let i = 1; i <= PRELOAD_COUNT; i++) {
                const nextIndex = (currentIndex + i) % images.length;
                const nextPath = images[nextIndex];
                const fileObject = fileObjectsMap.get(nextPath);

                if (fileObject && !preloadCache.has(nextPath)) {
                    const url = URL.createObjectURL(fileObject);
                    const preloadImg = new Image();
                    preloadImg.src = url;
                    preloadImg._blobUrl = url;
                    preloadCache.set(nextPath, preloadImg);
                }
            }

            // Clean up old cache entries
            if (preloadCache.size > PRELOAD_COUNT + 3) {
                const keepPaths = new Set();
                for (let i = -1; i <= PRELOAD_COUNT; i++) {
                    const idx = (currentIndex + i + images.length) % images.length;
                    keepPaths.add(images[idx]);
                }
                for (const [path, img] of preloadCache.entries()) {
                    if (!keepPaths.has(path)) {
                        if (img._blobUrl) {
                            URL.revokeObjectURL(img._blobUrl);
                        }
                        preloadCache.delete(path);
                    }
                }
            }
        }

        // Start
        init();
        initResize();
    </script>
</body>
</html>
